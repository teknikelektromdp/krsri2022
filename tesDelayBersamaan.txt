#include <Servo.h>
#include "hitungRobot.h"

Servo servoLFT,//left front top     (range depan=47,  belakang=125) jangkauan = 78
      servoLFM,//left front middle  (range atas=39,   bawah=117)    jangkauan = 78
      servoLFB,//left front bottom  (range dalam=41,  luar=136)     jangkauan = 95
      
      servoLBT,//left back top      (range depan=58,  belakang=130) jangkauan = 72
      servoLBM,//left back middle   (range atas=35,   bawah=113)    jangkauan = 78
      servoLBB,//left back bottom   (range dalam=36,  luar=131)     jangkauan = 95
      
      servoRFT,//right front top    (range depan=128, belakang=50)  jangkauan = 78
      servoRFM,//right front middle (range atas=137,  bawah=59)     jangkauan = 78
      servoRFB,//right front bottom (range dalam=140, luar=45)      jangkauan = 95
      
      servoRBT,//right back top     (range depan=132, belakang=60)  jangkauan = 72
      servoRBM,//right back middle  (range atas=142,  bawah=64)     jangkauan = 78
      servoRBB,//right back bottom   (range dalam=140, luar=45)      jangkauan = 95
      servoTes
      ;

//servo top
int lftForward=60,  lftBackward=138,
    lbtForward=58,  lbtBackward=130,
    rftForward=128, rftBackward=50,
    rbtForward=132, rbtBackward=60,
    rftTegak, rbtTegak, 
    lftTegak, lbtTegak;

//servo middle
int lfmUp=39,   lfmDown=117,
    lbmUp=35,   lbmDown=113,
    rfmUp=136,  rfmDown=58,
//    rfmUp=137,  rfmDown=59, //nilai lama
    rbmUp=142,  rbmDown=64,
    rfmTegak, rbmTegak, 
    lfmTegak, lbmTegak;

//servo bottom
int lfbIn=41,   lfbOut=136,
    lbbIn=36,   lbbOut=131,
    rfbIn=140,  rfbOut=45,
    rbbIn=140,  rbbOut=45,
    lfbTegak, lbbTegak,
    rfbTegak, rbbTegak;

//posisi servo saat ini
int posisiLFT=0, posisiLFM=0, posisiLFB=0,
    posisiLBT=0, posisiLBM=0, posisiLBB=0,
    posisiRFT=0, posisiRFM=0, posisiRFB=0,
    posisiRBT=0, posisiRBM=0, posisiRBB=0;

//waktu delay perpindahan servo untuk 1 derajat
int delayWaktu=4;


void setup() {
  servoLFT.attach(44);  servoLFM.attach(46);  servoLFB.attach(6);
  servoLBT.attach(9);  servoLBM.attach(4);  servoLBB.attach(2);
  servoRFT.attach(7);  servoRFM.attach(10);  servoRFB.attach(8);  
  servoRBT.attach(3);  servoRBM.attach(5);  servoRBB.attach(12);

  lftTegak=lftForward + 43; lbtTegak=lbtForward + 32;
  rftTegak=rftForward - 43; rbtTegak=rbtForward - 32;
  
  lfmTegak=lfmUp + 50; lbmTegak=lbmUp + 50;
  rfmTegak=rfmUp - 50; rbmTegak=rbmUp - 50;

  lfbTegak=lfbIn + 51; lbbTegak=lbbIn + 51;
  rfbTegak=rfbIn - 51; rbbTegak=rbbIn - 51;
}

void loop() {
  hitungRobot.SETUP();
  delay(2000);



  delay(1000);
  Berdiri();

  delay(1000);
  int kondisi = 0;
  while(kondisi==0){
  PutarKiri();
  }


  

  /**
   * robot menentukan hadap keluar home
   */

   

  /**
   * Keadaan robot maju menelusuri jalan sebelum rintangan puing pertama
   * angkat 30 derajat sampai saat ini yang tercepat untuk maju
   * angkat 50 derajat untuk melewati puing
  MajuAwal();//persiapan robot maju

  int kondisi=0;//kondisi untuk menentukan apakah terus berjalan
  while (kondisi==0){
    MajuKanan(30);
    MajuKananDorong();
    MajuKiri(30);
    MajuKiriDorong();
  }
  Berdiri();//keadaan akhir robot maju (robot berhenti)
   */





  /**
   * robot memposisikan diri menghadap rintangan puing
   */







  /**
   * robot melewati rintangan puing pertama
  MajuAwal();//persiapan robot maju

  int kondisi=0;//kondisi untuk menentukan apakah terus berjalan
  while (kondisi==0){
    MajuKanan(50);
    MajuKananDorong();
    MajuKiri(50);
    MajuKiriDorong();
  }
  Berdiri();//keadaan akhir robot maju (robot berhenti)
   */  

}

/**
 * fungsi keadaan awal robot (kondisi berdiri)
 * semua sudut bernilai nol
 */
void Berdiri(){
  ServoWrite("LFT",0);  ServoWrite("RFT",0);
  ServoWrite("LBT",0);  ServoWrite("RBT",0);

  ServoWrite("LFM",0);  ServoWrite("RFM",0);
  ServoWrite("LBM",0);  ServoWrite("RBM",0);

  ServoWrite("LFB",0);  ServoWrite("RFB",0);
  ServoWrite("LBB",0);  ServoWrite("RBB",0);
}







/**
 * fungsi membatasi nilai minimum dan maksimum
 */
int NilaiBatas(int nilai, int nilaiMin, int nilaiMax){
  if (nilai>nilaiMax) nilai=nilaiMax;
  else if (nilai<nilaiMin) nilai=nilaiMin;
  return nilai;
}

/** 
 * fungsi mendapatkan sudut sebenarnya dari servo 
 * servoTujuan diisi dengan kode LFT, LBT, RFT, dst
 * nilai diisi dengan sudut yang diinginkan
 */
int SudutReal(String servoTujuan, int nilai) {
  int nilaiReal;
  
  if (servoTujuan.equals("LFT")) {//-35 s/d 43
    nilaiReal = (lftTegak - NilaiBatas(nilai, -35, 43));
  } else if (servoTujuan.equals("LBT")) {//-40 s/d 32
    nilaiReal = (lbtTegak - NilaiBatas(nilai, -40, 32));
  } else if (servoTujuan.equals("RFT")) {//-35 s/d 43
    nilaiReal = (rftTegak + NilaiBatas(nilai, -35, 43));
  } else if (servoTujuan.equals("RBT")) {//-40 s/d 32
    nilaiReal = (rbtTegak + NilaiBatas(nilai, -40, 32));
  } else if (servoTujuan.equals("LFM")) {//-28 s/d 50
    nilaiReal = (lfmTegak - NilaiBatas(nilai, -28, 50));
  } else if (servoTujuan.equals("LBM")) {//-28 s/d 50
    nilaiReal = (lbmTegak - NilaiBatas(nilai, -28, 50));
  } else if (servoTujuan.equals("RFM")) {//-28 s/d 50
    nilaiReal = (rfmTegak + NilaiBatas(nilai, -28, 50));
  } else if (servoTujuan.equals("RBM")) {//-28 s/d 50
    nilaiReal = (rbmTegak + NilaiBatas(nilai, -28, 50));
  } else if (servoTujuan.equals("LFB")) {//-51 s/d 44
    nilaiReal = (lfbTegak + NilaiBatas(nilai, -51, 44));
  } else if (servoTujuan.equals("LBB")) {//-51 s/d 44
    nilaiReal = (lbbTegak + NilaiBatas(nilai, -51, 44));
  } else if (servoTujuan.equals("RFB")) {//-51 s/d 44
    nilaiReal = (rfbTegak - NilaiBatas(nilai, -51, 44));
  } else if (servoTujuan.equals("RBB")) {//-51 s/d 44
    nilaiReal = (rbbTegak - NilaiBatas(nilai, -51, 44));
  } else {//kondisi error akan terjadi robot berdiri selama 2 detik
    Berdiri();
    delay(2000);
  }
  return nilaiReal;
}

/**
 * fungsi untuk menggerakkan servo dan sekaligus menyimpan sudut servo saat ini
 */
void ServoWrite(String servoNama, int sudut) {
  Servo servoPakai;
  if (servoNama.equals("LFT")) {
    servoPakai=servoLFT;  posisiLFT=sudut;
  } else if (servoNama.equals("LFM")) {
    servoPakai=servoLFM;  posisiLFM=sudut;
  } else if (servoNama.equals("LFB")) {
    servoPakai=servoLFB;  posisiLFB=sudut;
  
  } else if (servoNama.equals("LBT")) {
    servoPakai=servoLBT;  posisiLBT=sudut;
  } else if (servoNama.equals("LBM")) {
    servoPakai=servoLBM;  posisiLBM=sudut;
  } else if (servoNama.equals("LBB")) {
    servoPakai=servoLBB;  posisiLBB=sudut;
  
  } else if (servoNama.equals("RFT")) {
    servoPakai=servoRFT;  posisiRFT=sudut;
  } else if (servoNama.equals("RFM")) {
    servoPakai=servoRFM;  posisiRFM=sudut;
  } else if (servoNama.equals("RFB")) {
    servoPakai=servoRFB;  posisiRFB=sudut;
  
  } else if (servoNama.equals("RBT")) {
    servoPakai=servoRBT;  posisiRBT=sudut;
  } else if (servoNama.equals("RBM")) {
    servoPakai=servoRBM;  posisiRBM=sudut;
  } else if (servoNama.equals("RBB")) {
    servoPakai=servoRBB;  posisiRBB=sudut;
  }
  
  servoPakai.write(SudutReal(servoNama,sudut));
}

/**
 * Fungsi menggerakkan servo dengan perlahan
 */
void ServoMovementSingle(String servoNama, int sudutBaru) {
  int sudutLama, pengali, jarak;
  
  sudutLama=PosisiServo(servoNama);
  jarak=HitungJarak(sudutLama, sudutBaru);
  pengali=HitungPengali(sudutLama, sudutBaru);

  for (int i=1; i<=jarak; i++) {
    ServoWrite(servoNama, sudutLama + (pengali * i));
    delay(delayWaktu);
  }
}

void ServoMovementDouble(
  String servoNama1, int sudutBaru1, 
  String servoNama2, int sudutBaru2
) {
  int sudutLama1, pengali1, jarak1,
      sudutLama2, pengali2, jarak2,
      sudutTemp1, sudutTemp2, minimum, maksimum;
      
  sudutLama1=PosisiServo(servoNama1);
  sudutLama2=PosisiServo(servoNama2);

  jarak1=HitungJarak(sudutLama1, sudutBaru1);
  pengali1=HitungPengali(sudutLama1, sudutBaru1);

  jarak2=HitungJarak(sudutLama2, sudutBaru2);
  pengali2=HitungPengali(sudutLama2, sudutBaru2);

  //menghitung nilai terkecil dari jarak1 dan jarak2
  minimum=jarak1;
  if (jarak2 < minimum) minimum=jarak2;

  //menghitung nilai terbesar dari jarak1 dan jarak2
  maksimum=jarak1;
  if (jarak2 > maksimum) maksimum=jarak2;
  
  //melakukan pergerakan servo secara bersamaan dari sudutLama ke sudutBaru
  for (int i=1; i<=minimum; i++) {
    sudutTemp1 = sudutLama1 + (pengali1 * i * (jarak1/minimum));
    sudutTemp2 = sudutLama2 + (pengali2 * i * (jarak2/minimum));

    if ((pengali1==1 && sudutTemp1<=sudutBaru1) || (pengali1==-1 && sudutTemp1>=sudutBaru1)) {
      ServoWrite(servoNama1, sudutTemp1);    
    }
    if ((pengali2==1 && sudutTemp2<=sudutBaru2) || (pengali2==-1 && sudutTemp2>=sudutBaru2)) {
      ServoWrite(servoNama2, sudutTemp2);
    }
    
    delay((maksimum/minimum)*delayWaktu);
  }
}

void ServoMovementTriple(
  String servoNama1, int sudutBaru1, 
  String servoNama2, int sudutBaru2,
  String servoNama3, int sudutBaru3
) {
  int sudutLama1, pengali1, jarak1,
      sudutLama2, pengali2, jarak2,
      sudutLama3, pengali3, jarak3,
      sudutTemp1, sudutTemp2, sudutTemp3, minimum, maksimum;
      
  sudutLama1=PosisiServo(servoNama1);
  sudutLama2=PosisiServo(servoNama2);
  sudutLama3=PosisiServo(servoNama3);

  jarak1=HitungJarak(sudutLama1, sudutBaru1);
  pengali1=HitungPengali(sudutLama1, sudutBaru1);

  jarak2=HitungJarak(sudutLama2, sudutBaru2);
  pengali2=HitungPengali(sudutLama2, sudutBaru2);

  jarak3=HitungJarak(sudutLama3, sudutBaru3);
  pengali3=HitungPengali(sudutLama3, sudutBaru3);

  //menghitung nilai terkecil dari jarak1, jarak2, dan jarak3
  minimum=jarak1;
  if (jarak2 < minimum) minimum=jarak2;
  else if (jarak3 < minimum) minimum=jarak3;

  //menghitung nilai terbesar dari jarak1, jarak2, dan jarak3
  maksimum=jarak1;
  if (jarak2 > maksimum) maksimum=jarak2;
  else if (jarak3 > maksimum) maksimum=jarak3;
  
  //melakukan pergerakan servo secara bersamaan dari sudutLama ke sudutBaru
  for (int i=1; i<=minimum; i++) {
    sudutTemp1 = sudutLama1 + (pengali1 * i * (jarak1/minimum));
    sudutTemp2 = sudutLama2 + (pengali2 * i * (jarak2/minimum));
    sudutTemp3 = sudutLama3 + (pengali3 * i * (jarak3/minimum));

    if ((pengali1==1 && sudutTemp1<=sudutBaru1) || (pengali1==-1 && sudutTemp1>=sudutBaru1)) {
      ServoWrite(servoNama1, sudutTemp1);    
    }
    if ((pengali2==1 && sudutTemp2<=sudutBaru2) || (pengali2==-1 && sudutTemp2>=sudutBaru2)) {
      ServoWrite(servoNama2, sudutTemp2);
    }
    if ((pengali3==1 && sudutTemp3<=sudutBaru3) || (pengali3==-1 && sudutTemp3>=sudutBaru3)) {
      ServoWrite(servoNama3, sudutTemp3);
    }
    
    delay((maksimum/minimum)*delayWaktu);
  }
}
/**
 * Fungsi mendapatkan sudut saat ini dari servo
 */
int PosisiServo(String servoNama) {
  if (servoNama.equals("LFT")) return posisiLFT;
  else if (servoNama.equals("LFM")) return posisiLFM;
  else if (servoNama.equals("LFB")) return posisiLFB;
  
  else if (servoNama.equals("LBT")) return posisiLBT;
  else if (servoNama.equals("LBM")) return posisiLBM;
  else if (servoNama.equals("LBB")) return posisiLBB;
  
  else if (servoNama.equals("RFT")) return posisiRFT;
  else if (servoNama.equals("RFM")) return posisiRFM;
  else if (servoNama.equals("RFB")) return posisiRFB;
  
  else if (servoNama.equals("RBT")) return posisiRBT;
  else if (servoNama.equals("RBM")) return posisiRBM;
  else if (servoNama.equals("RBB")) return posisiRBB;  
}

/**
 * Fungsi hitung jarak sudut lama dengan sudut baru
 */
int HitungJarak(int sudutLama, int sudutBaru) {
  if (sudutLama < sudutBaru) return (sudutBaru-sudutLama);
  else if (sudutLama > sudutBaru) return (sudutLama-sudutBaru);
  else return 0;//untuk sudutLama sama dengan sudutBaru
}

/**
 * Fungsi hitung pengali antara sudut lama dengan sudut baru
 * untuk menentukan pergerakan menaik atau menurun
 */
int HitungPengali(int sudutLama, int sudutBaru) {
  if (sudutLama < sudutBaru) return 1;
  else if (sudutLama > sudutBaru) return -1;
  else return 1;//untuk sudutLama sama dengan sudutBaru  
}


////////////
// prosedur berjalan
////////////

void MajuAwal() {
  //memposisikan kaki untuk pergerakan awal
  ServoMovementDouble("RFT", -20, "LBT", -20);
  delay(10);
}

void MajuKananDorong() {
  //kaki kanan depan, kanan belakang, dan kaki kiri depan bersiap untuk menekan ke bawah
  ServoMovementTriple("RFB", 5, "RBB", 5, "LFB", 5);
  ServoMovementTriple("RFM", -5, "RBM", -5, "LFM", -5);
  delay(10);

  //kedua kaki kanan dan kaki kiri depan mendorong ke depan
  ServoMovementTriple("RFT", 0, "RBT", -20, "LFT", -20);
  delay(10);

  //kembalikan sudut kedua kaki kanan dan kaki kiri depan
  ServoMovementTriple("RFB", 0, "RBB", 0, "LFB", 0);
  ServoMovementTriple("RFM", 0, "RBM", 0, "LFM", 0);
  delay(10);
}

void MajuKiri(int tinggiAngkat //ketinggian servo middle yang diangkat
) {
  //majukan kaki kiri belakang bersamaan dengan menaikkannya
  ServoMovementDouble("LBT", 15, "LBM", tinggiAngkat);

  //majukan kaki kiri belakang bersamaan dengan menurunkannya
  ServoMovementDouble("LBT", 30, "LBM", 0);
  delay(10);
  
  //majukan kaki kiri depan bersamaan dengan menaikkannya
  ServoMovementDouble("LFT", 20, "LFM", tinggiAngkat);

  //majukan kaki kiri depan bersamaan dengan menurunkannya
  ServoMovementDouble("LFT", 40, "LFM", 0);
  delay(10);
}

void MajuKiriDorong() {
  //kedua kaki kiri dan kaki kanan depan untuk menekan ke bawah
  ServoMovementTriple("LFB", 5, "LBB", 5, "RFB", 5);
  ServoMovementTriple("LFM", -5, "LBM", -5, "RFM", -5);
  delay(10);

  //kedua kaki kiri dan kaki kanan depan mendorong ke depan
  ServoMovementTriple("LFT", 0, "LBT", -20, "RFT", -20);
  delay(10);

  //kembalikan sudut kedua kaki kiri dan kaki kanan depan
  ServoMovementTriple("LFB", 0, "LBB", 0, "RFB", 0);
  ServoMovementTriple("LFM", 0, "LBM", 0, "RFM", 0);
  delay(10);
}

void MajuKanan(int tinggiAngkat //ketinggian servo middle yang diangkat
) {
  //majukan kaki kanan belakang bersamaan dengan menaikkannya
  ServoMovementDouble("RBT", 15, "RBM", tinggiAngkat);

  //majukan kaki kanan belakang bersamaan dengan menurunkannya
  ServoMovementDouble("RBT", 30, "RBM", 0);
  delay(10);
  
  //majukan kaki kanan depan bersamaan dengan menaikkannya
  ServoMovementDouble("RFT", 20, "RFM", tinggiAngkat);

  //majukan kaki kanan depan bersamaan dengan menurunkannya
  ServoMovementDouble("RFT", 40, "RFM", 0);
  delay(10);
}

void PutarKiri(){
  //majukan kaki kiri depan bersamaan dengan menaikkannya
  ServoMovementDouble("LFT", -15, "LFM", 40);

  //majukan kaki kiri depan bersamaan dengan menurunkannya
  ServoMovementDouble("LFT", -30, "LFM", 0);
  delay(100);
  
  //majukan kaki kiri belakang bersamaan dengan menaikkannya
  ServoMovementDouble("LBT", -15, "LBM", 40);

  //majukan kaki kiri belakang bersamaan dengan menurunkannya
  ServoMovementDouble("LBT", -30, "LBM", 0);
  delay(100);

  //majukan kaki kanan belakang bersamaan dengan menaikkannya
  ServoMovementDouble("RBT", 15, "RBM", 40);

  //majukan kaki kanan belakang bersamaan dengan menurunkannya
  ServoMovementDouble("RBT", 30, "RBM", 0);
  delay(100);
  
  //majukan kaki kanan depan bersamaan dengan menaikkannya
  ServoMovementDouble("RFT", 15, "RFM", 40);

  //majukan kaki kanan depan bersamaan dengan menurunkannya
  ServoMovementDouble("RFT", 30, "RFM", 0);
  delay(100);

  //balik kedua kaki kiri bersamaan tanpa menaikkannya
  ServoMovementDouble("LBT", 0, "LFT", 0);
  delay(10);

  //balik kedua kaki kanan bersamaan tanpa menurunkannya
  ServoMovementDouble("RBT", 0, "RFT", 0);
  delay(10);
}